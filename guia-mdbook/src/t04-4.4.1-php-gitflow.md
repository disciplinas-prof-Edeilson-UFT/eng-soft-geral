# Cadastro de usu치rios no sistema

### Criar conex칚o com banco de dados via PDO (_exemplo do projeto conex_)

Arquivo: t04-db/database.php

```php

class Database
{
    private static $instance = null;
    private $conn;

    private function __construct()
    {
        $config = require __DIR__ . '/config.php';

        if (!isset($config['database']['host'], $config['database']['port'], $config['database']['username'], $config['database']['password'], $config['database']['dbname'])) {
            throw new Exception("Configura칞칚o do banco de dados incompleta");
        }

        $dsn = "mysql:host={$config['database']['host']};port={$config['database']['port']};dbname={$config['database']['dbname']};charset=utf8mb4";

        try {
            $this->conn = new PDO($dsn, $config['database']['username'], $config['database']['password'], [
                PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
            ]);
        } catch (PDOException $e) {
            throw new Exception("Falha na conex칚o com o banco de dados: " . $e->getMessage());
        }
    }

    public static function getInstance()
    {
        if (self::$instance === null) {
            self::$instance = new self();
        }
        return self::$instance;
    }

    public function getConnection()
    {
        return $this->conn;
    }
}
```
_C칩digo respons치vel por estabelecer a conex칚o com o banco de dados._

No exemplo apresentado, a classe "Database" 칠 implementada utilizando o design pattern "Singleton". Esse pattern tem como objetivo garantir que exista apenas uma inst칙ncia da classe durante o tempo de execu칞칚o da aplica칞칚o, facilitando o gerenciamento e o reuso da conex칚o com o banco de dados. 

### Observa칞칫es

---

```php
$config = require __DIR__ . '/config.php';
```

_Aqui, o c칩digo carrega um arquivo chamado config.php que cont칠m as configura칞칫es do banco de dados._

```php
if (!isset($config['database']['host'], $config['database']['port'], $config['database']['username'], $config['database']['password'], $config['database']['dbname'])) {
            throw new Exception("Configura칞칚o do banco de dados incompleta");
        }
```

_Aqui, o c칩digo verifica se todas as chaves necess치rias (host, port, username, password, dbname) existem no array $config['database']._

```php
 $dsn = "mysql:host={$config['database']['host']};port={$config['database']['port']};dbname={$config['database']['dbname']};charset=utf8mb4";
```

_O DSN 칠 a string usada pelo PDO para conectar ao banco de dados._

_Host (`host`), Porta (`port`), Nome do banco (`dbname`), Charset (`utf8mb4`)_

```php
try {
    $this->conn = new PDO($dsn, $config['database']['username'], $config['database']['password'], [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
    ]);
} catch (PDOException $e) {
    throw new Exception("Falha na conex칚o com o banco de dados: " . $e->getMessage());
}
```

_Aqui, o c칩digo tenta criar uma conex칚o com o banco de dados usando a classe PDO._

---

Arquivo: t04-db/config.php

```php
<?php
return [
    'database' => [
        'host' => 'localhost',
        'port' => '3306',
        'username' => 'root',
        'password' => '',
        'dbname' => 'conex'
    ]
];
```
> **游뚿 Para usu치rios de XAMPP:**
> - Teste e Valida칞칚o:
> 1. Salve o arquivo `database.php` no diret칩rio do seu servidor (htdocs no XAMPP).
> 2. Acesse `http://localhost/database.php` no navegador.
> 3. Caso a conex칚o seja bem-sucedida, a p치gina ficar치 em branco.

### Implementar backend da view "signup.php" (_exemplo do projeto conex_)

Arquivo: t04-db\view\signup.php

```html
    <form class="form-group" method="POST" action="../src/post-user.php">
      <div class="icon">
        <img src="../public/img/logo.svg" alt="logo" class="logo" />
      </div>

      <!-- resto do c칩digo... -->
```

_Com esssa altera칞칚o o form de cadastro agora est치 referenciado ao codigo de controle de cadastro de usu치rios, seguido do verbo http POST_

---

Arquivo: Arquivo: t04-db\src\post-user.php

```php
<?php

require_once __DIR__ . '/../database.php';
require_once __DIR__ . '/users.php';

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $name = trim($_POST['name']);
    $phone = trim($_POST['phone']);
    $email = trim($_POST['email']);
    $password = $_POST['password'];
    $password_confirm = $_POST['password-confirm'];

    if (empty($name) || empty($phone) || empty($email) || empty($password) || empty($password_confirm)) {
        $_SESSION['error'] = "Todos os campos s칚o obrigat칩rios!";
        header("Location: /view/signup.php?error=todos-os-campos-obrigatorios");
        exit();
    }

    if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        $_SESSION['error'] = "Email inv치lido!";
        header("Location: /view/signup.php?error=email-invalido");
        exit();
    }

    if ($password !== $password_confirm) {
        $_SESSION['error'] = "As senhas n칚o coincidem!";
        header("Location: /view/signup.php?error=confirma칞칚o-de-senha-diferente");
        exit();
    }

    $database = Database::getInstance();
    $users = new Users($database);

    if ($users->checkEmailExists($email)) {
        $_SESSION['error'] = "Este email j치 est치 registrado!";
        header("Location: /view/signup.php?error=email-ja-registrado");
        exit();
    }

    $password_hash = password_hash($password, PASSWORD_ARGON2I);

    if ($users->createUser($name, $email, $password_hash, $phone)) {
        $_SESSION['success'] = "Usu치rio cadastrado com sucesso!";
        header("Location: /");
        exit();
    } else {
        $_SESSION['error'] = "Erro ao cadastrar o usu치rio!";
        header("Location: /view/signup.php?error=erro-ao-cadastrar-usuario");
        exit();
    }
}
```

Aqui, o c칩digo processa o formul치rio de cadastro de usu치rios (`signup.php`) enviado via m칠todo POST. Ele valida os dados recebidos, verifica se o e-mail j치 est치 cadastrado, cria um novo usu치rio no banco de dados e redireciona o usu치rio com mensagens de sucesso ou erro.

**O objetivo principal deste c칩digo 칠:**

1. Processar o formul치rio de cadastro de usu치rios.

2. Validar os dados fornecidos pelo usu치rio (campos obrigat칩rios, formato de e-mail, confirma칞칚o de senha).

3. Verificar se o e-mail j치 est치 cadastrado no banco de dados.

4. Criar um novo usu치rio no banco de dados com os dados fornecidos.

5. Redirecionar o usu치rio com feedback adequado (sucesso ou erro).

---

Arquivo: t04-db\src\users.php

```php
class Users
{
    private $db;

    public function __construct(Database $db)
    {
        $this->db = $db->getConnection();
    }

    public function createUser($username, $email, $password, $phone)
    {
        $sql = "INSERT INTO users (username, email, password_hash, phone) VALUES (:username, :email, :password_hash, :phone)";
        $stmt = $this->db->prepare($sql);
        return $stmt->execute([
            ':username' => $username,
            ':email' => $email,
            ':password_hash' => $password,
            ':phone' => $phone
        ]);
    }

    public function checkEmailExists($email)
    {
        $sql = "SELECT id FROM users WHERE email = :email";
        $stmt = $this->db->prepare($sql);
        $stmt->execute([':email' => $email]);
        return $stmt->fetch() ? true : false;
    }
}
```

_Aqui, o c칩digo define uma classe chamada Users que tem como objetivo gerenciar opera칞칫es relacionadas a usu치rios no banco de dados, especificamente a cria칞칚o de novos usu치rios e a verifica칞칚o se um e-mail j치 est치 cadastrado._

## Conclus칚o

Este t칩pico abordou de maneira pr치tica a cria칞칚o, conex칚o e cadastro de um usu치rio em um banco de dados.

O exemplo demonstrou como configurar a conex칚o ao banco de dados utilizando `PDO` no `PHP`, garantindo que a comunica칞칚o entre o servidor e o banco seja segura e eficiente. Al칠m disso, o c칩digo abordou o processo de cadastro de um novo usu치rio, incluindo valida칞칫es de entrada, como a verifica칞칚o de e-mail e confirma칞칚o de senha, bem como a utiliza칞칚o de hashing para armazenamento seguro da senha no banco de dados.

